---
title: The Gateway-Error HTTP Header Field
abbrev: Gateway-Error
docname: draft-nottingham-gateway-error-00
date: 2019
category: info

ipr: trust200902
area: General
workgroup:
keyword: Internet-Draft

stand_alone: yes
pi: [toc, tocindent, sortrefs, symrefs, strict, compact, comments, inline]

author:
 -
    ins: M. Nottingham
    name: Mark Nottingham
    organization: Fastly
    email: mnot@mnot.net
    uri: https://www.mnot.net/

normative:
  RFC2119:

informative:


--- abstract

This document defines the Gateway-Error HTTP header field to convey the details of errors generated by HTTP gateways.


--- note_Note_to_Readers

*RFC EDITOR: please remove this section before publication*

The issues list for this draft can be found at <https://github.com/mnot/I-D/labels/gateway-error>.

The most recent (often, unpublished) draft is at <https://mnot.github.io/I-D/gateway-error/>.

See also the draft's current status in the IETF datatracker, at
<https://datatracker.ietf.org/doc/draft-nottingham-gateway-error/>.

Precursors that informed this work include (but are not limited to):

* https://docs.fastly.com/guides/debugging/common-503-errors
* https://support.cloudflare.com/hc/en-us/sections/200820298-Error-Pages
* https://cloud.google.com/load-balancing/docs/https/https-logging-monitoring
* https://docs.google.com/document/d/1fMEK80KlpHcL4CwhniOupgQu4MDsxK4y4dKhthjjCMA


--- middle

# Introduction

A gateway is defined by {{!RFC7230}} as "an intermediary that acts as an origin server for the outbound connection but translates received requests and forwards them inbound to another server or servers." They have increasingly become a significant part of HTTP deployments. Reverse Proxies and Content Delivery Networks (CDNs) form part of the critical infrastructure of many Web sites.

Typically, HTTP gateways forward requests to a configured origin server and then forward their responses back to clients. However, if an error occurs, the response is generated by the gateway itself.

HTTP accommodates these types of errors with a few status codes; specifically, 502 Bad Gateway and 504 Gateway Timeout. However, experience has shown that more information is necessary to aid debugging and communicate what's happened to the client.

To address this, {{header}} defines a new HTTP response header field to convey such information, using the Gateway Error Types defined in {{types}}. {{register}} explains how to define new Gateway Error Types.


## Notational Conventions

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
"RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as
described in BCP 14 {{!RFC2119}} {{!RFC8174}} when, and only when, they appear in all capitals, as
shown here.

This specification uses Structured Headers {{!I-D.ietf-httpbis-header-structure}} to specify syntax. The terms sh-param-list, sh-item, sh-string, sh-token and sh-integer refer to the structured types defined therein.


# The Gateway-Error HTTP Header Field {#header}

The Gateway-Error HTTP response header field allows a gateway to indicate the nature and details of an error condition it encounters when servicing a request.

It is a Structured Headers {{!I-D.ietf-httpbis-header-structure}} Parameterised List, where each item in the list indicates an error condition. Typically, it will have only one param-item (the error condition that triggered generation of the response it occurs within), but more than one value is not prohibited.

Each param-item's primary-id is a Gateway Error Type, a registered value that indicates the nature of the error.

Each param-item can have zero to many parameters. {{params}} lists parameters that can be used with all Gateway Error Types; individual types can define additional parameters to use with them. All parameters are optional; see {{security}} for their potential security impact.

For example:

~~~ example
HTTP/1.1 504 Gateway Timeout
Gateway-Error: origin_connect_timeout; gateway_id=FooCDN;
  origin_id=abc; origin_tries=3
~~~

indicates the specific nature of the timeout as a connect timeout to the origin with the identifier "abc", and that is was generated by the gateway that identifies itself as "FooCDN." Furthermore, three connection attempts were made.

Or:

~~~ example
HTTP/1.1 429 Too Many Requests
Gateway-Error: request_error; gateway_id=BarReverseProxy
~~~

indicates that this 429 Too Many Requests response was generated by the gateway, not the origin.

Each Gateway Error Type has a Recommended HTTP Status Code. When generating a HTTP response containing Gateway-Error, its http status code SHOULD be set to the Recommended HTTP Status Code. However, there may be circumstances (e.g., for backwards compatibility with previous behaviours) when another status code might be used.

{{types}} lists the Gateway Error Types defined in this document; new ones can be defined using the procedure outlined in {{register}}.

Note that there are various security considerations for gateways using the Gateway-Error header field; see {{security}}.

Origin servers MUST NOT generate the Gateway-Error header field.


## Generic Gateway Error Parameters {#params}

This section lists parameters that are potentially applicable to most Gateway Error Types.

* gateway_id - a sh-token identifying the gateway generating this response.
* origin_id - a sh-token identifying the origin whose behaviour triggered this response.
* origin_protocol - a sh-token indicating the ALPN protocol identifier {{!RFC7301}} used to connect to the origin. This is only applicable when the origin connection was actually established.
* origins_tried - a sh-integer indicating the number of origins that have been tried before generating this error.
* origin_tries - a sh-integer indicating the number of times that the error specified has occurred on the origin XXX.
* note - a sh-string containing additional information not captured anywhere else. This can include implementation-specific or deployment-specific information.


# Gateway Error Types {#types}

This section lists the Gateway Error Types defined by this document. See {{register}} for information about defining new Gateway Error Types.

## Origin Not Found

* Name: origin_not_found
* Description: The gateway cannot determine the appropriate origin to use for this request; for example, it may not be configured.
* Extra Parameters: None.
* Recommended HTTP status code: 500

## Origin DNS Timeout

* Name: origin_dns_timeout
* Description: The gateway encountered a timeout when trying to find an IP address for the origin's hostname.
* Extra Parameters: None.
* Recommended HTTP status code: 504

## Origin DNS Error

* Name: origin_dns_error
* Description: The gateway encountered a DNS error when trying to find an IP address for the origin's hostname.
* Extra Parameters:
  - rcode: A sh-string conveying the DNS RCODE that indicates the error type. See {{!RFC8499}}, Section 3.
* Recommended HTTP status code: 502

## Origin IP Prohibited

* Name: origin_ip_prohibited
* Description: The gateway is configured to prohibit connections to the origin's IP address.
* Extra Parameters: None.
* Recommended HTTP status code: 502

## Origin IP Unroutable

* Name: origin_ip_unroutable
* Description: The gateway cannot find a route to the origin's IP address.
* Extra Parameters: None.
* Recommended HTTP status code: 502

## Origin Connection Refused

* Name: origin_connection_refused
* Description: The gateway's connection to the origin was refused by the origin or an intervening network element.
* Extra Parameters: None.
* Recommended HTTP status code: 502

## Origin Connection Closed

* Name: origin_connection_closed
* Description: The gateway's connection to the origin was closed before any part of the response was received. If some part was received, see origin_http_incomplete.
* Extra Parameters: None.
* Recommended HTTP status code: 502

## Origin Connect Timeout

* Name: origin_connect_timeout
* Description: The gateway's attempt to connect to the origin timed out.
* Extra Parameters: None.
* Recommended HTTP status code: 504

## Origin Read Timeout

* Name: origin_read_timeout
* Description: The gateway expect
* Extra Parameters: None.
* Recommended HTTP status code: 504

## Origin Write Timeout

* Name: origin_write_timeout
* Description:
* Extra Parameters: None.
* Recommended HTTP status code: 504

## Origin Down

* Name: origin_down
* Description: The gateway considers the origin to be unavailable; e.g., recent attempts to communicate with it may have failed, or a health check may indicate that it is down.
* Extra Parameters:

* Recommended HTTP status code: 500

## Origin Connection Limit Reached

* Name: origin_connnection_limit
* Description: The gateway is configured to limit the number of connections it has to the origin, and that limit has been passed.
* Extra Parameters: None.
* Recommended HTTP status code:

## Origin HTTP Error Status

* Name: origin_http_error_status
* Description: The gateway has encountered a 4xx or 5xx status code from the origin server, and
* Extra Parameters: None.
* Recommended HTTP status code:

## Origin HTTP Incomplete Response

* Name: origin_http_incomplete
* Description: The gateway received an incomplete response to the request from the origin.
* Extra Parameters: None.
* Recommended HTTP status code: 502

## Origin HTTP Protocol Error

* Name: origin_http_protocol
* Description: The gateway encountered a HTTP protocol error when communicating with the origin. This error should only be used when a more specific one is not defined.
* Extra Parameters:
  - details: a sh-string containing details about the error condition. For example, this might be the HTTP/2 error code or free-form text describing the condition.
* Recommended HTTP status code: 502

## Origin HTTP Response Header Block Too Large

* Name: origin_http_response_header_block_size
* Description: The gateway received a response to the request whose header block was considered too large.
* Extra Parameters:
  - header_block_size: a sh-integer indicating how large the headers received were. Note that they might not be complete; i.e., the gateway may have discarded or refused additional data.
* Recommended HTTP status code: 502

## Origin HTTP Response Header Too Large

* Name: origin_http_response_header_size
* Description: The gateway received a response to the request containing an individual header line that was considered too large.
* Extra Parameters:
  - header_name: a sh-string indicating the name of the header that triggered the error.
* Recommended HTTP status code: 502

## Origin HTTP Response Body Too Large

* Name: origin_http_response_body_size
* Description: The gateway received a response to the request whose body was considered too large.
* Extra Parameters:
  - body_size: a sh-integer indicating how large the body received was. Note that it may not have been complete; i.e., the gateway may have discarded or refused additional data.
* Recommended HTTP status code: 502

## Origin HTTP Transfer-Coding Error

* Name: origin_http_transfer_coding
* Description: The gateway encountered an error decoding the transfer-coding of the origin's response.
* Extra Parameters:
  - coding: a sh-token containing the specific coding that caused the error.
  - details: a sh-string containing details about the error condition.
* Recommended HTTP status code: 502

## Origin HTTP Content-Coding Error

* Name: origin_http_content_coding
* Description: The gateway encountered an error decoding the content-coding of the origin's response.
* Extra Parameters:
  - coding: a sh-token containing the specific coding that caused the error.
  - details: a sh-string containing details about the error condition.
* Recommended HTTP status code: 502

## Origin TLS Error

* Name: origin_tls_error
* Description: The gateway encountered a TLS error when communicating with the origin.
* Extra Parameters:
  - alert_message: a sh-token containing the applicable description string from the TLS Alerts registry.
* Recommended HTTP status code: 502

## Gateway Internal Error

* Name: gateway_internal_error
* Description: The gateway encountered an internal error unrelated to the origin.
* Extra Parameters:
  - details: a sh-string containing details about the error condition.
* Recommended HTTP status code: 500

## Request Error

* Name: request_error
* Description: The gateway is generating a client (4xx) response on the origin's behalf. Applicable status codes include (but are not limited to) 400, 403, 405, 406, 408, 411, 413, 414, 415, 416, 417, 429. This gateway error code helps distinguish between responses generated by the gateway from those generated by the origin.
* Extra Parameters: None.
* Recommended HTTP status code: The applicable 4xx status code


# Defining New Gateway Error Types {#register}

New Gateway Error Types can be defined by registering them in the HTTP Gateway Error Types registry.

Registration requests are reviewed and approved by a Designated Expert, as per {{!RFC8126}} Section 4.5. A specification document is appreciated, but not required.

The Expert(s) should consider the following factors when evaluating requests:

* Community feedback
* If the value is sufficiently well-defined
* If the value is generic; vendor-specific, application-specific and deployment-specific values are discouraged

Registration requests should use the following template:

* Name: [a name for the Gateway Error Type that is allowable as a sh-param-list key]
* Description: [a description of the conditions that generate the Gateway Error Types]
* Extra Parameters: [zero or more optional parameters, typed using one of the types available in sh-item]
* Recommended HTTP status code: [the appropriate HTTP status code for this entry]

See the registry at <https://iana.org/assignments/http-gateway-errors> for details on where to send registration requests.


# IANA Considerations

Upon publication, please create the HTTP Gateway Error Types registry at <https://iana.org/assignments/http-gateway-errors> and populate it with the types defined in {{types}}; see {{register}} for its associated procedures.


# Security Considerations {#security}

One of the primary security concerns when using Gateway-Error is leaking information that might aid an attacker.

As a result, care needs to be taken when deciding to generate a Gateway-Error header. Note that gateways are not required to generate a Gateway-Header header field in any response, and can conditionally generate them based upon request attributes (e.g., authentication tokens, IP address).

Likewise, generation of all parameters is optional.

Special care needs to be taken in generating gateway_id and origin_id parameters, as they can expose information about the gateway's configuration and back-end topology.

--- back
